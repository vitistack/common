name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write # Required for keyless signing with Sigstore

env:
  REGISTRY: ghcr.io
  HELM_REGISTRY: ghcr.io/vitistack/helm
  # Optional override for pushing/signing to an org-owned GHCR package (e.g. ghcr.io/vitistack/helm/*).
  # If not set, the workflow falls back to the repo-scoped GITHUB_TOKEN.
  GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || github.actor }}
  GHCR_TOKEN: ${{ secrets.GHCR_TOKEN || github.token }}

jobs:
  # Package Helm chart
  package-helm:
    name: Package Helm Chart
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate CRDs and Artifacts
        run: |
          make generate
          make verify-crds
          make gen-crds-yaml

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update chart versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          yq -i ".version = \"${VERSION}\"" charts/vitistack-crds/Chart.yaml
          yq -i ".appVersion = \"${VERSION}\"" charts/vitistack-crds/Chart.yaml

      - name: Package Helm chart
        run: helm package charts/vitistack-crds

      - name: Upload chart artifact
        uses: actions/upload-artifact@v6
        with:
          name: helm-chart
          path: crds-*.tgz
          retention-days: 1

      - name: Upload crds.yaml artifact
        uses: actions/upload-artifact@v6
        with:
          name: crds-yaml
          path: crds.yaml
          retention-days: 1

  # Publish and sign
  publish-and-sign:
    name: Publish & Sign
    needs: [package-helm]
    runs-on: ubuntu-latest
    steps:
      - name: Download Helm chart
        uses: actions/download-artifact@v7
        with:
          name: helm-chart
          path: /tmp/helm

      - name: Download crds.yaml
        uses: actions/download-artifact@v7
        with:
          name: crds-yaml
          path: .

      - name: Push Helm chart
        run: |
          echo "${{ env.GHCR_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u "${{ env.GHCR_USERNAME }}" --password-stdin
          helm push /tmp/helm/crds-*.tgz oci://${{ env.HELM_REGISTRY }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Login to GHCR for Cosign
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Sign Helm chart
        run: cosign sign --yes ${{ env.HELM_REGISTRY }}/crds:${{ needs.package-helm.outputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: crds.yaml
